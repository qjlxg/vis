name: è‡ªåŠ¨è·å– C ç±»åŸºé‡‘ä»£ç 

on:
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # å®šæ—¶è§¦å‘ï¼ˆæ¯å¤©å‡Œæ™¨ 00:00 UTC è¿è¡Œï¼Œå³åŒ—äº¬æ—¶é—´ 08:00ï¼‰
  schedule:
    - cron: '0 0 * * *'
  # å½“æ­¤å·¥ä½œæµæ–‡ä»¶æˆ– Python è„šæœ¬è¢«æ¨é€æ—¶è§¦å‘
  push:
    paths:
      - '.github/workflows/C0ç±».yml'
      - 'fetch_c_fund_codes.py'

jobs:
  update-c-codes:
    runs-on: ubuntu-latest
    
    # å¯ç”¨å†™å…¥æƒé™ï¼Œä»¥ä¾¿ GITHUB_TOKEN å¯ä»¥æäº¤æ–‡ä»¶
    permissions:
      contents: write

    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # ä½¿ç”¨å†…ç½®çš„ GITHUB_TOKENï¼Œå¹¶æŒä¹…åŒ–å‡­è¯ä»¥ç”¨äºåç»­ git push
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      # æ­¥éª¤ 2: è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # æ­¥éª¤ 3: å®‰è£…ä¾èµ–åº“ (åªéœ€ requestsï¼Œç§»é™¤äº†æœªä½¿ç”¨çš„ pandas)
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # æ­¥éª¤ 4: æ‰§è¡Œ Python è„šæœ¬ï¼Œç”Ÿæˆ C0ç±».txt
      - name: Run C fund code script
        run: python fetch_c_fund_codes.py

      # æ­¥éª¤ 5: é…ç½® Git æäº¤èº«ä»½
      - name: Configure Git user
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # æ­¥éª¤ 6: æäº¤å’Œæ¨é€ C0ç±».txt
      - name: Commit and Push C0ç±».txt
        run: |
          # æ£€æŸ¥ C0ç±».txt æ˜¯å¦å­˜åœ¨æˆ–æœ‰å˜åŒ–
          if [ -f "C0ç±».txt" ] && ! git diff --quiet -- "C0ç±».txt"; then
              echo "C0ç±».txt has changes, attempting to commit..."
              
              git add C0ç±».txt
              
              # åˆ›å»ºæäº¤ä¿¡æ¯
              git commit -m "ğŸ¤– chore: Update C fund codes (C0ç±».txt)"
              
              # *** å…³é”®ï¼šæ‹‰å–è¿œç¨‹æœ€æ–°å†…å®¹å¹¶ rebaseï¼Œè§£å†³å®šæ—¶ä»»åŠ¡å¯èƒ½å‘ç”Ÿçš„æ¨é€å†²çª ***
              # é»˜è®¤åˆ†æ”¯é€šå¸¸æ˜¯ main æˆ– masterï¼Œè¿™é‡Œå‡è®¾æ˜¯ main
              git pull --rebase origin $(git branch --show-current) 
              
              # æ¨é€æ›´æ”¹
              git push
              echo "Successfully committed and pushed C0ç±».txt"
          else
              echo "C0ç±».txt not found or no changes detected. Skipping commit."
          fi

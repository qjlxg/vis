name: 自动获取 C 类基金代码

on:
  # 允许手动触发
  workflow_dispatch:
  # 定时触发（每天凌晨 00:00 UTC 运行，即北京时间 08:00）
  schedule:
    - cron: '0 0 * * *'
  # 当此工作流文件或 Python 脚本被推送时触发
  push:
    paths:
      - '.github/workflows/C0类.yml'
      - 'fetch_c_fund_codes.py'

jobs:
  update-c-codes:
    runs-on: ubuntu-latest
    
    # 启用写入权限，以便 GITHUB_TOKEN 可以提交文件
    permissions:
      contents: write

    steps:
      # 步骤 1: 检出仓库代码
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # 使用内置的 GITHUB_TOKEN，并持久化凭证以用于后续 git push
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      # 步骤 2: 设置 Python 环境
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # 步骤 3: 安装依赖库 (只需 requests，移除了未使用的 pandas)
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # 步骤 4: 执行 Python 脚本，生成 C0类.txt
      - name: Run C fund code script
        run: python fetch_c_fund_codes.py

      # 步骤 5: 配置 Git 提交身份
      - name: Configure Git user
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # 步骤 6: 提交和推送 C0类.txt
      - name: Commit and Push C0类.txt
        run: |
          # 检查 C0类.txt 是否存在或有变化
          if [ -f "C0类.txt" ] && ! git diff --quiet -- "C0类.txt"; then
              echo "C0类.txt has changes, attempting to commit..."
              
              git add C0类.txt
              
              # 创建提交信息
              git commit -m "🤖 chore: Update C fund codes (C0类.txt)"
              
              # *** 关键：拉取远程最新内容并 rebase，解决定时任务可能发生的推送冲突 ***
              # 默认分支通常是 main 或 master，这里假设是 main
              git pull --rebase origin $(git branch --show-current) 
              
              # 推送更改
              git push
              echo "Successfully committed and pushed C0类.txt"
          else
              echo "C0类.txt not found or no changes detected. Skipping commit."
          fi

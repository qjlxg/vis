name: å‡€å€¼æ›´æ–° Fetch Fund Net Value Data

# å®šä¹‰è§¦å‘æ¡ä»¶
on:
  # è§¦å‘ 1: æ‰‹åŠ¨è§¦å‘ï¼Œå…è®¸åœ¨ GitHub Actions é¡µé¢ç‚¹å‡»â€œRun workflowâ€è¿è¡Œ
  workflow_dispatch:
   
  # è§¦å‘ 2: æ–‡ä»¶å˜æ›´æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    paths:
      - '.github/workflows/fetch_fund_data.yml'
      - 'fund_spider.py'
      - 'Cç±».txt'

  # è§¦å‘ 3: å®šæ—¶è¿è¡Œï¼ˆæ¯ 3 å°æ—¶ï¼‰
  schedule:
      - cron: 0 */3 * * * # æ¯å¤©è¿è¡Œ 8 æ¬¡

jobs:
  update-data:
    runs-on: ubuntu-latest
    

    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # æ­¥éª¤ 2: è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # æ­¥éª¤ 3: ç¼“å­˜ Python ä¾èµ–
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # æ­¥éª¤ 4: å®‰è£…ä¾èµ–åº“
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # ç¡®ä¿æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬ lxml å’Œ tenacityï¼‰éƒ½å®‰è£…
          pip install pandas requests beautifulsoup4 aiohttp lxml tenacity

      # æ­¥éª¤ 5: æ‰§è¡Œ Python çˆ¬è™«è„šæœ¬
      # *** å…³é”®ä¿®æ”¹: æ·»åŠ  continue-on-error: true ***
      # å³ä½¿è„šæœ¬å´©æºƒï¼Œå·¥ä½œæµä¹Ÿä¼šç»§ç»­åˆ°æäº¤æ­¥éª¤ï¼Œç¡®ä¿å·²æŠ“å–çš„æ•°æ®ï¼ˆCSV/JSONï¼‰ä¸ä¼šä¸¢å¤±ã€‚
      - name: Run fund spider script
        run: |
          python fund_spider.py
        # å…è®¸æ­¤æ­¥éª¤å¤±è´¥ï¼Œä½†å·¥ä½œæµç»§ç»­æ‰§è¡Œ
        continue-on-error: true 

      # æ­¥éª¤ 6: æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æˆ–æ›´æ–°çš„æ•°æ®æ–‡ä»¶å¹¶æäº¤
      # æäº¤çš„æ•°æ®åŒ…æ‹¬ CSV (å®é™…æ•°æ®) å’Œ JSON (ç¼“å­˜è¿›åº¦)
      - name: Commit and Push new data
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          file_pattern: 'fund_data/*.csv fund_data/*.json'
          commit_message: "ğŸ¤– chore: Update fund net value data at ${{ github.event.schedule || github.event.head_commit.timestamp || 'manual run' }}"
          # å³ä½¿ä¸Šä¸€æ­¥å¤±è´¥ï¼ˆå³ continue-on-errorï¼‰ï¼Œä¹Ÿå°è¯•æäº¤
          skip_dirty_check: false

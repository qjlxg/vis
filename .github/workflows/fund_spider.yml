name: Fetch Fund Net Value Data

# å®šä¹‰è§¦å‘æ¡ä»¶
on:
  # è§¦å‘ 1: æ‰‹åŠ¨è§¦å‘ï¼šå…è®¸åœ¨ GitHub Actions é¡µé¢ä¸Šç‚¹å‡»â€œRun workflowâ€æ¥è¿è¡Œ
  workflow_dispatch:
  
  # ã€æ–°å¢ã€‘è§¦å‘ 2: æ–‡ä»¶å˜æ›´æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    paths:
      - '.github/workflows/fetch_fund_data.yml'
      - 'fund_spider.py'

  # ã€æ›´æ–°ã€‘è§¦å‘ 3: å®šæ—¶è¿è¡Œï¼ˆæ¯ 3 å°æ—¶ï¼‰
  schedule:
    # cron è¡¨è¾¾å¼ '0 1,4,7,10,13,16,19,22 * * *' å¯¹åº” UTC æ—¶é—´ï¼Œ
    # è½¬æ¢åˆ°ä¸Šæµ·æ—¶é—´ (CST, UTC+8) å³ä¸ºï¼š
    # 09:00, 12:00, 15:00, 18:00, 21:00, 00:00, 03:00, 06:00
    - cron: '0 1,4,7,10,13,16,19,22 * * *' 

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # å…è®¸ action æäº¤åˆ°ä»“åº“
          token: ${{ secrets.GITHUB_TOKEN }} 
      
      # æ­¥éª¤ 2: è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          
      # æ­¥éª¤ 3: å®‰è£…ä¾èµ–åº“
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests beautifulsoup4 aiohttp lxml tenacity
          
      # æ­¥éª¤ 4: æ‰§è¡Œ Python çˆ¬è™«è„šæœ¬
      - name: Run fund spider script
        run: python fund_spider.py
        
      # æ­¥éª¤ 5: æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æˆ–æ›´æ–°çš„æ•°æ®æ–‡ä»¶å¹¶æäº¤
      - name: Commit and Push new data
        # ä½¿ç”¨ç¬¬ä¸‰æ–¹ action æ¥å¤„ç†æ–‡ä»¶çš„æäº¤å’Œæ¨é€
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          
          file_pattern: 'fund_data/*.csv fund_data/*.json'
          commit_message: "ğŸ¤– chore: Update fund net value data"
          # ä»…åœ¨æ–‡ä»¶æœ‰å˜åŒ–æ—¶æ‰æäº¤
          skip_dirty_check: false
          push_options: '--force' 

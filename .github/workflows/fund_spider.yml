name: å‡€å€¼æ›´æ–° Fetch Fund Net Value Data

# å®šä¹‰è§¦å‘æ¡ä»¶
on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # å½“ fund_spider.py æˆ– Cç±».txt æœ‰å˜åŠ¨æ—¶è§¦å‘
  push:
    paths:
      - '.github/workflows/fund_spider.yml'
      - 'fund_spider.py'
      - 'Cç±».txt'
  # å®šæ—¶è§¦å‘ï¼ˆä¾‹å¦‚æ¯ 10 å°æ—¶ä¸€æ¬¡ï¼‰
  schedule:
      - cron: '0 */10 * * *'

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»“åº“ä»£ç  (å…³é”®ä¿®æ”¹: æ·»åŠ æƒé™)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # æˆäºˆ actions ä»¤ç‰Œå†™å…¥æƒé™
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      # æ­¥éª¤ 2: è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # æ­¥éª¤ 3: ç¼“å­˜ Python ä¾èµ–
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # æ­¥éª¤ 4: å®‰è£…ä¾èµ–åº“
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # ç¡®ä¿å®‰è£…äº†æ‰€æœ‰ä¾èµ–ï¼ŒåŒ…æ‹¬ç”¨äºå¼‚æ­¥æŠ“å–ã€è§£æå’Œé‡è¯•çš„åº“
          pip install pandas requests beautifulsoup4 aiohttp lxml tenacity
      
      # æ­¥éª¤ 5ï¼šè®¾ç½® Git æäº¤èº«ä»½
      - name: Configure Git identity
        run: |
          # ä½¿ç”¨ Actions æœºå™¨äººä½œä¸ºæäº¤è€…
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # æ­¥éª¤ 6: è¿è¡Œ Python çˆ¬è™«è„šæœ¬
      - name: Run fund spider script
        run: |
          python fund_spider.py
        # å…è®¸æ­¤æ­¥éª¤å¤±è´¥ï¼Œä½†å·¥ä½œæµç»§ç»­æ‰§è¡Œï¼Œä»¥ä¾¿æäº¤å·²ä¿å­˜çš„æ•°æ®
        continue-on-error: true 

      # æ­¥éª¤ 7: æäº¤å’Œæ¨é€æ–°æ•°æ®
      - name: Commit and Push new data
        # æ— è®ºå‰é¢æ­¥éª¤ç»“æœå¦‚ä½•ï¼Œéƒ½æ‰§è¡Œæ­¤æ­¥éª¤
        if: always()
        run: |
          echo "Checking for new/updated files (CSV and fund_info.json)..."
          
          # æ£€æŸ¥ fund_data ç›®å½•æ˜¯å¦å­˜åœ¨ä¸”åŒ…å« CSV æ–‡ä»¶ (ä¸»è¦æ£€æŸ¥)
          # æ³¨æ„ï¼šfund_info.json æ–‡ä»¶ä¸åœ¨ fund_data ç›®å½•ä¸‹
          if [ -d "fund_data" ] && [ "$(ls -A fund_data/*.csv 2>/dev/null | wc -l)" -gt 0 ] || [ -f "fund_info.json" ]; then
              
              # *** å…³é”®æ›´æ–°ï¼šåŒæ—¶æ·»åŠ  fund_data/*.csv å’Œ fund_info.json ***
              git add fund_data/*.csv fund_info.json || true
              
              # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å¾…æäº¤
              if ! git diff --quiet --cached; then
                  echo "Found changes, attempting to commit..."
                  
                  # æäº¤ä¿¡æ¯åº”åæ˜ åŸºæœ¬ä¿¡æ¯å’Œå‡€å€¼çš„æ›´æ–°
                  git commit -m "ğŸ¤– chore: Update fund data and info at ${{ github.event.schedule || github.event.head_commit.timestamp || 'manual run' }}"
                  
                  # å…³é”®ä¿®å¤ï¼šåœ¨æ¨é€å‰æ‹‰å–è¿œç¨‹æœ€æ–°å†…å®¹å¹¶ rebaseï¼Œè§£å†³å†²çª
                  git pull --rebase origin main 
                  
                  # æ¨é€æ›´æ”¹
                  git push
                  echo "Successfully committed and pushed changes."
              else
                  echo "No changes found to commit."
              fi
          else
              echo "fund_data directory not found, is empty, or no fund_info.json generated. Skipping commit."
          fi

name: å‡€å€¼æ›´æ–° Fetch Fund Net Value Data

# å®šä¹‰è§¦å‘æ¡ä»¶
on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/fetch_fund_data.yml'
      - 'fund_spider.py'
      - 'Cç±».txt'
  schedule:
      - cron: 0 */10 * * *

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»“åº“ä»£ç  (å…³é”®ä¿®æ”¹: æ·»åŠ æƒé™)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # æˆäºˆ actions ä»¤ç‰Œå†™å…¥æƒé™
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      # æ­¥éª¤ 2: è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # æ­¥éª¤ 3: ç¼“å­˜ Python ä¾èµ– (ä¿æŒä¸å˜)
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # æ­¥éª¤ 4: å®‰è£…ä¾èµ–åº“ (ä¿æŒä¸å˜)
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests beautifulsoup4 aiohttp lxml tenacity
      
      # *** æ–°å¢æ­¥éª¤ 5ï¼šè®¾ç½® Git æäº¤èº«ä»½ ***
      - name: Configure Git user
        run: |
          git config user.name "GitHub Actions"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # æ­¥éª¤ 6: æ‰§è¡Œ Python çˆ¬è™«è„šæœ¬ (å…³é”®ä¿®æ”¹: ç¡®ä¿å³ä½¿å¤±è´¥ä¹Ÿç»§ç»­)
      - name: Run fund spider script
        run: |
          python fund_spider.py
        # å…è®¸æ­¤æ­¥éª¤å¤±è´¥ï¼Œä½†å·¥ä½œæµç»§ç»­æ‰§è¡Œï¼Œä»¥ä¾¿æäº¤å·²ä¿å­˜çš„æ•°æ®
        continue-on-error: true 

      # æ­¥éª¤ 7: æäº¤å’Œæ¨é€æ–°æ•°æ® (å…³é”®ä¿®æ”¹: å¼ºåˆ¶æ‰§è¡Œæäº¤)
      - name: Commit and Push new data
        # æ— è®ºå‰é¢æ­¥éª¤ç»“æœå¦‚ä½•ï¼Œéƒ½æ‰§è¡Œæ­¤æ­¥éª¤
        if: always()
        run: |
          echo "Checking for new/updated files in fund_data/..."
          
          # æ£€æŸ¥ fund_data ç›®å½•æ˜¯å¦å­˜åœ¨ä¸”åŒ…å«æ–‡ä»¶
          if [ -d "fund_data" ] && [ "$(ls -A fund_data/*.csv fund_data/*.json 2>/dev/null | wc -l)" -gt 0 ]; then
              # æ·»åŠ æ‰€æœ‰æ–°çš„æˆ–ä¿®æ”¹è¿‡çš„æ–‡ä»¶
              git add fund_data/*.csv fund_data/*.json || true
              
              # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å¾…æäº¤
              if ! git diff --quiet --cached; then
                  echo "Found changes, attempting to commit..."
                  git commit -m "ğŸ¤– chore: Update fund net value data at ${{ github.event.schedule || github.event.head_commit.timestamp || 'manual run' }}"
                  # æ¨é€æ›´æ”¹
                  git push
                  echo "Successfully committed and pushed changes."
              else
                  echo "No changes found to commit."
              fi
          else
              echo "fund_data directory not found or is empty. Skipping commit."
          fi

name: 净值更新Fetch Fund Net Value Data

# 定义触发条件
on:
  # 触发 1: 手动触发：允许在 GitHub Actions 页面上点击“Run workflow”来运行
  workflow_dispatch:
  
  # 【新增】触发 2: 文件变更时自动运行
  push:
    paths:
      - '.github/workflows/fetch_fund_data.yml'
      - 'fund_spider.py'

  # 【更新】触发 3: 定时运行（每 3 小时）
  schedule:
    # cron 表达式 '0 1,4,7,10,13,16,19,22 * * *' 对应 UTC 时间，
    # 转换到上海时间 (CST, UTC+8) 即为：
    # 09:00, 12:00, 15:00, 18:00, 21:00, 00:00, 03:00, 06:00
    - cron: '0 1,4,7,10,13,16,19,22 * * *' 

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      # 步骤 1: 检出仓库代码
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # 允许 action 提交到仓库
          token: ${{ secrets.GITHUB_TOKEN }} 
      
      # 步骤 2: 设置 Python 环境
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          
      # 步骤 3: 安装依赖库
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests beautifulsoup4 aiohttp lxml tenacity
          
      # 步骤 4: 执行 Python 爬虫脚本
      - name: Run fund spider script
        run: python fund_spider.py
        
      # 步骤 5: 检查是否有新的或更新的数据文件并提交
      - name: Commit and Push new data
        # 使用第三方 action 来处理文件的提交和推送
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          
          file_pattern: 'fund_data/*.csv fund_data/*.json'
          commit_message: "🤖 chore: Update fund net value data"
          # 仅在文件有变化时才提交
          skip_dirty_check: false
          push_options: '--force' 
